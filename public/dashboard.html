<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Bio Reator - Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #eef2f7;
    }
    .card {
      border-radius: 14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    h1 {
      font-weight: bold;
    }
    .config-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
	.label {
	  font-size: small;
	  color: darkgrey;
	}
	#alertContainer {
	  position: fixed;
	  top: 20px;
	  right: 20px;
	  z-index: 9999;
	  width: 300px;
	}

  </style>
</head>

<body class="p-4">

<!-- <div class="container mt-3"> -->
  <div id="alertContainer"></div>
<!-- </div> -->

<div class="container">

  <h1 class="mb-4 text-center">Bio Reator – Painel de Controle</h1>
  
  <p class="text-center text-muted">
    Última atualização do ESP32: 
    <b><span id="ultimaAtualizacao">--</span></b>
  </p>

  <div class="row g-4">

    <!-- CARD STATUS -->
    <div class="col-lg-6">
      <div class="card p-4">
        <h3>Status Atual</h3>
        <hr>
        <p class="fs-4"><b>Temperatura:</b> <span id="tempAtual">--</span> °C</p>
        <p class="fs-4"><b>OD:</b> <span id="odAtual">--</span> %</p>
		<p class="fs-4"><b>Distância:</b> <span id="distanciaAtual">--</span> cm</p>

		<hr>

        <p class="fs-4">
		  <b>Bomba1:</b> <span id="statusBomba1">--</span>
		  <label class="label"> (Rele 1 | Temp + OD + Período)</label>
		  <br><small class="text-muted" id="motivoBomba1">--</small>
		</p>

		<p class="fs-4">
		  <b>Bomba2:</b> <span id="statusBomba2">--</span> 
		  <label class="label"> (Rele 2 | Distância)</label>
		  <br><small class="text-muted" id="motivoBomba2">--</small>
		</p>

		<hr>
		<p class="fs-4"><b>Sistema:</b> <span id="statusSistema">--</span></p>
      </div>
    </div>

    <!-- GRÁFICO TEMPERATURA -->
    <div class="col-lg-6">
      <div class="card p-4">
        <h3>Monitoramento da Temperatura</h3>
        <hr>
        <canvas id="graficoTemp" height="150"></canvas>
      </div>
    </div>

    <!-- GRÁFICO OD -->
    <div class="col-lg-12">
      <div class="card p-4">
        <h3>Monitoramento do Oxigênio Dissolvido (OD)</h3>
        <hr>
        <canvas id="graficoOD" height="150"></canvas>
      </div>
    </div>
	
    <!-- GRÁFICO DISTANCIA -->
    <div class="col-lg-12">
      <div class="card p-4">
        <h3>Monitoramento de Distância</h3>
        <hr>
        <canvas id="graficoDist" height="150"></canvas>
      </div>
    </div>

  </div>

  <!-- CONFIGURAÇÕES -->
  <div class="config-panel mt-4">
    <h3>Configurações</h3>
    <hr>
	
	<div class="form-check form-switch mb-3">
	  <input class="form-check-input" type="checkbox" id="chkMultiplicacao" onchange="alterarModoMultiplicacao()">
	  <label class="form-check-label fs-5">Modo Multiplicação</label>
	</div>

    <div class="row g-3">

      <div class="col-md-3">
        <label class="form-label">Temperatura Máxima</label>
        <input id="tempMax" type="number" step="0.1" class="form-control">
      </div>

	  <!-- TEMPERATURA -->
      <div class="col-md-3">
        <label class="form-label">Temperatura Mínima</label>
        <input id="tempMin" type="number" step="0.1" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Minutos ligado</label>
        <input id="minLigado" type="number" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Minutos sem mudança</label>
        <input id="minSem" type="number" class="form-control">
      </div>

	  <!-- OD -->
      <div class="col-md-3">
        <label class="form-label mt-3">OD Mínimo (liga bomba 2)</label>
        <input id="odMin" type="number" step="0.1" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label mt-3">OD Máximo (desliga bomba 2)</label>
        <input id="odMax" type="number" step="0.1" class="form-control">
      </div>
	  
	  
      <div class="col-md-6">
      </div>
	  
	  <!-- DISTÂNCIA -->
	  <div class="col-md-3">
		<label class="form-label mt-3">Distância Mínima (cm) – Liga Bomba2</label>
		<input id="distMin" type="number" step="0.1" class="form-control">
	  </div>

	  <div class="col-md-3">
		<label class="form-label mt-3">Distância Máxima (cm) – Desliga Bomba2</label>
		<input id="distMax" type="number" step="0.1" class="form-control">
	  </div>

    </div>

    <button class="btn btn-primary btn-lg mt-4" onclick="salvar()">Salvar Alterações</button>
	
    <button class="btn btn-primary btn-lg mt-4" onclick="forcarAtualizacao()">Atualizar ESP32 agora</button>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBunmzsROUpo8miGHs9lffr70cRwX0cY98",
    authDomain: "bio-reator.firebaseapp.com",
    databaseURL: "https://bio-reator-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>

<script>
  // --------------------------
  // GRÁFICO TEMPERATURA
  // --------------------------
  const ctxTemp = document.getElementById('graficoTemp').getContext('2d');

  const graficoTemp = new Chart(ctxTemp, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Temperatura (°C)",
        data: [],
        borderWidth: 3,
        borderColor: "#ff4d4d",
        tension: 0.2
      }]
    }
  });

  // --------------------------
  // GRÁFICO DISTÂNCIA
  // --------------------------
  const ctxDist = document.getElementById('graficoDist').getContext('2d');

  const graficoDist = new Chart(ctxDist, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Distância (cm)",
        data: [],
        borderWidth: 3,
        borderColor: "#007bff",
        tension: 0.2
      }]
    }
  });

  // --------------------------
  // GRÁFICO OD
  // --------------------------
  const ctxOD = document.getElementById('graficoOD').getContext('2d');

  const graficoOD = new Chart(ctxOD, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "OD (%)",
        data: [],
        borderWidth: 3,
        borderColor: "#28a745",
        tension: 0.2
      }]
    }
  });

  // --------------------------
  // STATUS REMOTO
  // --------------------------

  db.ref("status/temperatura").on("value", snap => {
    const v = snap.val();
    document.getElementById("tempAtual").innerText = v ?? "--";

    if (v != null) {
      const t = new Date().toLocaleTimeString("pt-BR", {hour12: false});
      graficoTemp.data.labels.push(t);
      graficoTemp.data.datasets[0].data.push(v);

      if (graficoTemp.data.labels.length > 20) {
        graficoTemp.data.labels.shift();
        graficoTemp.data.datasets[0].data.shift();
      }

      graficoTemp.update();
    }
  });

  db.ref("status/od").on("value", snap => {
    const v = snap.val();
    document.getElementById("odAtual").innerText = v ?? "--";

    if (v != null) {
      const t = new Date().toLocaleTimeString("pt-BR", {hour12: false});
      graficoOD.data.labels.push(t);
      graficoOD.data.datasets[0].data.push(v);

      if (graficoOD.data.labels.length > 20) {
        graficoOD.data.labels.shift();
        graficoOD.data.datasets[0].data.shift();
      }

      graficoOD.update();
    }
  });
  
  db.ref("status/distancia").on("value", snap => {
	const d = snap.val();
    document.getElementById("distanciaAtual").innerText = d ?? "--";

    if (d != null) {
      const t = new Date().toLocaleTimeString("pt-BR", {hour12: false});
      graficoDist.data.labels.push(t);
      graficoDist.data.datasets[0].data.push(d);

      if (graficoDist.data.labels.length > 20) {
        graficoDist.data.labels.shift();
        graficoDist.data.datasets[0].data.shift();
      }

      graficoDist.update();
    }
  });

  db.ref("status/bomba1").on("value", snap => {
    const estado = snap.val();
    document.getElementById("statusBomba1").innerText =
      estado == "LIGADA" ? "Ligada" : "Desligada";
  });
  
  db.ref("status/bomba2").on("value", snap => {
    const estado = snap.val();
    document.getElementById("statusBomba2").innerText =
      estado == "LIGADA" ? "Ligada" : "Desligada";
  });
  
  db.ref("status/bomba1_motivo").on("value", snap => {
	document.getElementById("motivoBomba1").innerText = snap.val() ?? "--";
  });

  db.ref("status/bomba2_motivo").on("value", snap => {
	document.getElementById("motivoBomba2").innerText = snap.val() ?? "--";
  });

  db.ref("status/sistema").on("value", snap => {
    document.getElementById("statusSistema").innerText = snap.val().toUpperCase() ?? "--";
  });
  
  db.ref("status/ultima_atualizacao").on("value", snap => {
    const v = snap.val();
    if (!v) return;

    const data = new Date(v).toLocaleString("pt-BR", { hour12: false });
    document.getElementById("ultimaAtualizacao").innerText = data;
  });

  // --------------------------
  // CONFIGURAÇÕES
  // --------------------------
  db.ref("config").on("value", snap => {
    const c = snap.val();
    if (!c) return;

    document.getElementById("tempMax").value = c.temperatura_max ?? "";
    document.getElementById("tempMin").value = c.temperatura_min ?? "";
    document.getElementById("minLigado").value = c.intervalo_ligado ?? "";
    document.getElementById("minSem").value = c.intervalo_sem_mudanca ?? "";
    document.getElementById("odMin").value = c.od_min ?? "";
    document.getElementById("odMax").value = c.od_max ?? "";
	document.getElementById("distMin").value = c.distancia_min ?? "";
	document.getElementById("distMax").value = c.distancia_max ?? "";
	document.getElementById("chkMultiplicacao").checked = snap.val().multiplicacao ?? false;
  });

  function mostrarAlerta(mensagem, tipo = "success") {
    const id = "alert_" + Date.now();

    const html = `
	  <div id="${id}" class="alert alert-${tipo} alert-dismissible fade show" role="alert">
	    ${mensagem}
	    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	  </div>
    `;

    const container = document.getElementById("alertContainer");
    container.insertAdjacentHTML("beforeend", html);

    // Remover automaticamente após 5 segundos
    setTimeout(() => {
	  const alertEl = document.getElementById(id);
	  if (alertEl) {
	    alertEl.classList.remove("show");
	    setTimeout(() => alertEl.remove(), 150);
	  }
    }, 5000);
  }


  function salvar() {
    db.ref("config").update({
      temperatura_max: parseFloat(document.getElementById("tempMax").value),
      temperatura_min: parseFloat(document.getElementById("tempMin").value),
      intervalo_ligado: parseInt(document.getElementById("minLigado").value),
      intervalo_sem_mudanca: parseInt(document.getElementById("minSem").value),
      od_min: parseFloat(document.getElementById("odMin").value),
      od_max: parseFloat(document.getElementById("odMax").value),
	  distancia_min: parseFloat(document.getElementById("distMin").value),
	  distancia_max: parseFloat(document.getElementById("distMax").value)
    });

    mostrarAlerta("Configurações salvas com sucesso!", "success");
  }
  
  function forcarAtualizacao() {
	db.ref("comandos/atualizar").set(firebase.database.ServerValue.TIMESTAMP)
	  .then(() => {
	    mostrarAlerta("Comando enviado! O ESP32 irá atualizar agora.", "success");
	  })
	  .catch(err => {
	    console.error(err);
	    mostrarAlerta("Erro ao enviar comando.", "danger");
	  });
  }
  
  function alterarModoMultiplicacao() {
    const ativo = document.getElementById("chkMultiplicacao").checked;

	db.ref("config").update({
	  multiplicacao: ativo
	});

	db.ref("status").update({
	  sistema: ativo ? "ligado" : "desligado"
	});
  }

</script>

</body>
</html>
